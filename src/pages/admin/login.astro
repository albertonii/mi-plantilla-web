---
import AdminLayout from '../../layouts/admin/AdminLayout.astro';
---

<AdminLayout title="Login">
  <div class="min-h-screen flex items-center justify-center bg-dark-950 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <div class="mx-auto h-12 w-12 bg-primary-600 rounded-lg flex items-center justify-center">
          <span class="text-2xl">üîê</span>
        </div>
        <h2 class="mt-6 text-center text-3xl font-space-grotesk font-bold text-gray-100">
          Acceso Administrativo
        </h2>
        <p class="mt-2 text-center text-sm text-gray-400">
          Ingresa tus credenciales para acceder al panel de administraci√≥n
        </p>
      </div>
      
      <form class="mt-8 space-y-6" id="login-form">
        <div class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
              Email
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder="admin@cms.com"
            />
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-gray-300 mb-2">
              Contrase√±a
            </label>
            <input
              id="password"
              name="password"
              type="password"
              required
              class="w-full px-4 py-3 bg-dark-800 border border-dark-600 rounded-lg text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <input
              id="remember-me"
              name="remember-me"
              type="checkbox"
              class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-dark-600 rounded bg-dark-800"
            />
            <label for="remember-me" class="ml-2 block text-sm text-gray-300">
              Recordarme
            </label>
          </div>
          
          <div class="text-sm">
            <a href="#" class="font-medium text-primary-400 hover:text-primary-300">
              ¬øOlvidaste tu contrase√±a?
            </a>
          </div>
        </div>

        <div>
          <button
            type="submit"
            class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
          >
            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
              <svg class="h-5 w-5 text-primary-300 group-hover:text-primary-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </span>
            Iniciar Sesi√≥n
          </button>
        </div>
      </form>
      
      <div class="text-center">
        <p class="text-sm text-gray-400">
          ¬øProblemas para acceder? 
          <a href="/contacto" class="font-medium text-primary-400 hover:text-primary-300">
            Contacta al administrador
          </a>
        </p>
      </div>
    </div>
  </div>

  <script>
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // Configurar Supabase
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
    
    if (!supabaseUrl || !supabaseAnonKey) {
      console.error('‚ùå Variables de entorno de Supabase no encontradas');
    }

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const loginForm = document.getElementById('login-form');
    
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(loginForm);
        const email = formData.get('email');
        const password = formData.get('password');
        const submitButton = loginForm.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        
        // Cambiar texto del bot√≥n
        submitButton.textContent = 'Iniciando sesi√≥n...';
        submitButton.disabled = true;
        
        try {
          console.log('üîê Intentando login con Supabase...');
          
          // Autenticaci√≥n con Supabase
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
          });
          
          if (error) {
            console.error('‚ùå Error de autenticaci√≥n:', error.message);
            throw new Error(error.message);
          }
          
          if (data.user) {
            console.log('‚úÖ Login exitoso:', data.user.email);
            
            // Guardar informaci√≥n del usuario
            localStorage.setItem('admin-user', JSON.stringify({
              id: data.user.id,
              email: data.user.email,
              name: data.user.user_metadata?.name || 'Administrador'
            }));
            
            // Redirigir al panel de administraci√≥n
            window.location.href = '/admin';
          } else {
            throw new Error('No se pudo autenticar al usuario');
          }
          
        } catch (error) {
          console.error('‚ùå Error:', error);
          alert('Error de autenticaci√≥n: ' + error.message);
        } finally {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      });
    }
  </script>
</AdminLayout>
